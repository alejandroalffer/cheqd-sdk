<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2844" height="3321" contentScriptType="application/ecmascript" contentStyleType="text/css" style="width:2844px;height:3321px" preserveAspectRatio="none" version="1.1" viewBox="0 0 2844 3321" zoomAndPan="magnify"><defs><filter id="f96s0w8" width="300%" height="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4" dy="4" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text x="1342" y="23.132" fill="#000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158">DID Exchange Protocol</text><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="855" x2="855" y1="68.197" y2="3283.738"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="1058.5" x2="1058.5" y1="68.197" y2="3283.738"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="1244.5" x2="1244.5" y1="68.197" y2="3283.738"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="1431" x2="1431" y1="68.197" y2="3283.738"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="1678.5" x2="1678.5" y1="68.197" y2="3283.738"/><line style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5" x1="2029" x2="2029" y1="68.197" y2="3283.738"/><rect style="stroke:#a80036;stroke-width:1.5" width="44" height="30.099" x="831" y="33.099" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="838" y="53.23" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30">Alice</text><rect style="stroke:#a80036;stroke-width:1.5" width="44" height="30.099" x="831" y="3282.738" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="838" y="3302.87" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30">Alice</text><rect style="stroke:#a80036;stroke-width:1.5" width="95" height="30.099" x="1009.5" y="33.099" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1016.5" y="53.23" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81">Alice Agency</text><rect style="stroke:#a80036;stroke-width:1.5" width="95" height="30.099" x="1009.5" y="3282.738" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1016.5" y="3302.87" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81">Alice Agency</text><rect style="stroke:#a80036;stroke-width:1.5" width="85" height="30.099" x="1200.5" y="33.099" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1207.5" y="53.23" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71">Alice Agent</text><rect style="stroke:#a80036;stroke-width:1.5" width="85" height="30.099" x="1200.5" y="3282.738" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1207.5" y="3302.87" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71">Alice Agent</text><rect style="stroke:#a80036;stroke-width:1.5" width="142" height="30.099" x="1358" y="33.099" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1365" y="53.23" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128">Alice Pairwise Agent</text><rect style="stroke:#a80036;stroke-width:1.5" width="142" height="30.099" x="1358" y="3282.738" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1365" y="3302.87" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128">Alice Pairwise Agent</text><rect style="stroke:#a80036;stroke-width:1.5" width="39" height="30.099" x="1657.5" y="33.099" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1664.5" y="53.23" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25">Bob</text><rect style="stroke:#a80036;stroke-width:1.5" width="39" height="30.099" x="1657.5" y="3282.738" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1664.5" y="3302.87" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25">Bob</text><rect style="stroke:#a80036;stroke-width:1.5" width="80" height="30.099" x="1987" y="33.099" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1994" y="53.23" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66">Bob Agent</text><rect style="stroke:#a80036;stroke-width:1.5" width="80" height="30.099" x="1987" y="3282.738" fill="#FEFECE" filter="url(#f96s0w8)"/><text x="1994" y="3302.87" fill="#000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66">Bob Agent</text><rect style="stroke:#eee;stroke-width:1" width="2836" height="3" x="3" y="98.672" fill="#EEE" filter="url(#f96s0w8)"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="98.672" y2="98.672"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="101.672" y2="101.672"/><rect style="stroke:#000;stroke-width:2" width="98" height="22.949" x="1372" y="88.197" fill="#EEE" filter="url(#f96s0w8)"/><text x="1378" y="104.391" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80">Provisioning</text><polygon fill="#A80036" points="1047 291.633 1057 295.633 1047 299.633 1051 295.633" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1053" y1="295.633" y2="295.633"/><text x="862" y="291.827" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">Provision Alice</text><polygon fill="#FBFB77" points="193 126.146 193 449.146 846 449.146 846 136.146 836 126.146 193 126.146" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="126.146" y2="136.146"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="136.146" y2="136.146"/><text x="199" y="143.34" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76">Agency side:</text><text x="211" y="158.289" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242">We can keep the common workflow as is.</text><text x="211" y="173.237" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395">We still can create Pairwise Agents on the initiation of connection or</text><text x="243" y="188.186" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303">accepting an invitation but use it as a mediator only.</text><text x="211" y="203.135" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304">In the current state Pairwise Agents are already able</text><text x="227" y="218.083" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166">- collect incoming messages</text><text x="227" y="233.032" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161">- return collected messages</text><text x="227" y="247.981" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219">- update status of received messages</text><text x="199" y="277.878" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="632">The key difference is that we will not use Agency anymore for sending messages to another connection side,</text><text x="227" y="292.827" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329">so we don&apos;t need to keep other side keys on the Agency.</text><text x="199" y="307.776" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320">Vcx will do the message preparation and sending itself.</text><text x="199" y="337.673" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259">There is a problem with message forwarding:</text><text x="211" y="352.622" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522">Now DIDs must be used as target (`to` filed) according to Cross-Domain Messaging HIPE.</text><text x="199" y="367.571" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527">This problem is reflected in the issue: https://github.com/hyperledger/aries-rfcs/issues/255.</text><text x="199" y="382.519" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268">Lovesh&apos;s suggestion sounds acceptable to us.</text><text x="199" y="412.417" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="505">So, we need to change on Agency is making support of messages forwarding based on</text><text x="215" y="427.366" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247">Alice Verkey&apos;s (in addition to DID&apos;s based).</text><text x="199" y="442.315" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="589">It should be easy to distinguish because fully-qualified DID&apos;s must be used for a new protocol version.</text><polygon fill="#A80036" points="1233 475.069 1243 479.069 1233 483.069 1237 479.069" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1059" x2="1239" y1="479.069" y2="479.069"/><text x="1066" y="475.263" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">Provision Alice</text><polygon fill="#A80036" points="2017 517.441 2027 521.441 2017 525.441 2021 521.441" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1679" x2="2023" y1="521.441" y2="521.441"/><polygon fill="#FBFB77" points="2034 493.018 2034 547.018 2498 547.018 2498 503.018 2488 493.018 2034 493.018" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="2488" x2="2488" y1="493.018" y2="503.018"/><line style="stroke:#a80036;stroke-width:1" x1="2498" x2="2488" y1="503.018" y2="503.018"/><text x="2040" y="510.212" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="443">In this diagram, we assume that Bob uses different Aries, compatible Agent.</text><text x="2040" y="525.161" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338">He has published DIDDoc which is resolvable by Bob DID.</text><text x="2040" y="540.109" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371">Alice will send messages to Bob actor directly for simplification.</text><rect style="stroke:#eee;stroke-width:1" width="2836" height="3" x="3" y="577.339" fill="#EEE" filter="url(#f96s0w8)"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="577.339" y2="577.339"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="580.339" y2="580.339"/><rect style="stroke:#000;stroke-width:2" width="76" height="22.949" x="1383" y="566.864" fill="#EEE" filter="url(#f96s0w8)"/><text x="1389" y="583.058" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58">Invitation</text><line style="stroke:#a80036;stroke-width:1" x1="855" x2="897" y1="634.21" y2="634.21"/><line style="stroke:#a80036;stroke-width:1" x1="897" x2="897" y1="634.21" y2="647.21"/><line style="stroke:#a80036;stroke-width:1" x1="856" x2="897" y1="647.21" y2="647.21"/><polygon fill="#A80036" points="866 643.21 856 647.21 866 651.21 862 647.21" style="stroke:#a80036;stroke-width:1"/><text x="862" y="629.456" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190">initiate connection establishment</text><polygon fill="#FBFB77" points="419 604.813 419 658.813 846 658.813 846 614.813 836 604.813 419 604.813" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="604.813" y2="614.813"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="614.813" y2="614.813"/><text x="425" y="622.007" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347">`vcx_connection_create` -&gt; create `Connection` state object</text><text x="425" y="636.956" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406">`vcx_connection_connect` -&gt; create Alice Pairwise Agent on Agency,</text><text x="457" y="651.904" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367">prepares `invite` message containing Alice DIDDoc and send it.</text><polygon fill="#A80036" points="1047 684.659 1057 688.659 1047 692.659 1051 688.659" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1053" y1="688.659" y2="688.659"/><text x="862" y="684.853" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162">Create Alice Pairwise Agent</text><polygon fill="#A80036" points="1233 713.608 1243 717.608 1233 721.608 1237 717.608" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1059" x2="1239" y1="717.608" y2="717.608"/><text x="1066" y="713.802" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162">Create Alice Pairwise Agent</text><polygon fill="#A80036" points="1419 742.557 1429 746.557 1419 750.557 1423 746.557" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1245" x2="1425" y1="746.557" y2="746.557"/><text x="1252" y="742.75" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162">Create Alice Pairwise Agent</text><polygon fill="#A80036" points="866 771.505 856 775.505 866 779.505 862 775.505" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="860" x2="1430" y1="775.505" y2="775.505"/><text x="872" y="771.699" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165">Alice Pairwise Agent Verkey</text><polygon fill="#A80036" points="1667 857.775 1677 861.775 1667 865.775 1671 861.775" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1673" y1="861.775" y2="861.775"/><text x="862" y="857.968" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244">Share plain `invitation` message with Bob.</text><polygon fill="#FBFB77" points="337 789.454 337 918.454 846 918.454 846 799.454 836 789.454 337 789.454" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="789.454" y2="799.454"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="799.454" y2="799.454"/><text x="343" y="806.648" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">{</text><text x="359" y="821.597" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/didexchange/1.0/invitation&quot;,</text><text x="359" y="836.545" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195">&quot;@id&quot;: &quot;12345678900987654321&quot;,</text><text x="359" y="851.494" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88">&quot;label&quot;: &quot;Alice&quot;,</text><text x="359" y="866.443" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246">&quot;recipientKeys&quot;: [&quot;Alice Pairwise Verkey&quot;],</text><text x="359" y="881.392" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297">&quot;serviceEndpoint&quot;: &quot;https://example.com/endpoint&quot;,</text><text x="359" y="896.34" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410">&quot;routingKeys&quot;: [&quot;Alice Agency Verkey&quot;, &quot;Alice Pairwise Agent Verkey&quot;]</text><text x="343" y="911.289" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><rect style="stroke:#eee;stroke-width:1" width="2836" height="3" x="3" y="948.518" fill="#EEE" filter="url(#f96s0w8)"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="948.518" y2="948.518"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="951.518" y2="951.518"/><rect style="stroke:#000;stroke-width:2" width="143" height="22.949" x="1349.5" y="938.044" fill="#EEE" filter="url(#f96s0w8)"/><text x="1355.5" y="954.238" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125">Connection Request</text><line style="stroke:#a80036;stroke-width:1" x1="1679" x2="1721" y1="991.941" y2="991.941"/><line style="stroke:#a80036;stroke-width:1" x1="1721" x2="1721" y1="991.941" y2="1004.941"/><line style="stroke:#a80036;stroke-width:1" x1="1680" x2="1721" y1="1004.941" y2="1004.941"/><polygon fill="#A80036" points="1690 1000.941 1680 1004.941 1690 1008.941 1686 1004.941" style="stroke:#a80036;stroke-width:1"/><text x="1686" y="987.187" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336">process `invite` message and create `connection_request`</text><polygon fill="#A80036" points="1070 1078.788 1060 1082.788 1070 1086.788 1066 1082.788" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1064" x2="1678" y1="1082.788" y2="1082.788"/><text x="1076" y="1078.981" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426">Send `encrypted_fwd_request` to `serviceEndpoint` taken from `invitation`</text><polygon fill="#FBFB77" points="1684 1017.941 1684 1131.941 2149 1131.941 2149 1027.941 2139 1017.941 1684 1017.941" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="2139" x2="2139" y1="1017.941" y2="1027.941"/><line style="stroke:#a80036;stroke-width:1" x1="2149" x2="2139" y1="1027.941" y2="1027.941"/><text x="1690" y="1035.135" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="444">encrypted_fwd_request = &lt;pack(forward_message, &quot;Alice Agency Verkey&quot;)&gt;</text><text x="1690" y="1065.033" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122">forward_message = {</text><text x="1698" y="1079.981" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/routing/1.0/forward&quot;,</text><text x="1698" y="1094.93" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220">&quot;to&quot; : &quot;Alice Pairwise Agent Verkey&quot;,</text><text x="1698" y="1109.879" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256">&quot;msg&quot; : encrypted_forward_inner_message</text><text x="1690" y="1124.828" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><polygon fill="#A80036" points="1419 1157.582 1429 1161.582 1419 1165.582 1423 1161.582" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1059" x2="1425" y1="1161.582" y2="1161.582"/><text x="1066" y="1157.776" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255">forward `encrypted_forward_inner_message`</text><line style="stroke:#a80036;stroke-width:1" x1="1431" x2="1473" y1="1227.352" y2="1227.352"/><line style="stroke:#a80036;stroke-width:1" x1="1473" x2="1473" y1="1227.352" y2="1240.352"/><line style="stroke:#a80036;stroke-width:1" x1="1432" x2="1473" y1="1240.352" y2="1240.352"/><polygon fill="#A80036" points="1442 1236.352 1432 1240.352 1442 1244.352 1438 1240.352" style="stroke:#a80036;stroke-width:1"/><polygon fill="#FBFB77" points="1481 1175.531 1481 1289.531 2091 1289.531 2091 1185.531 2081 1175.531 1481 1175.531" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="2081" x2="2081" y1="1175.531" y2="1185.531"/><line style="stroke:#a80036;stroke-width:1" x1="2091" x2="2081" y1="1185.531" y2="1185.531"/><text x="1487" y="1192.725" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="589">encrypted_forward_inner_message = &lt;pack(forward_inner_message, &quot;Alice Pairwise Agent Verkey&quot;)&gt;</text><text x="1487" y="1222.623" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157">forward_inner_message = {</text><text x="1495" y="1237.571" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/routing/1.0/forward&quot;,</text><text x="1495" y="1252.52" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182">&quot;to&quot; : &quot;Alice Pairwise Verkey&quot;,</text><text x="1495" y="1267.469" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162">&quot;msg&quot; : encrypted_request</text><text x="1487" y="1282.418" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><line style="stroke:#a80036;stroke-width:1" x1="1431" x2="1473" y1="1320.121" y2="1320.121"/><line style="stroke:#a80036;stroke-width:1" x1="1473" x2="1473" y1="1320.121" y2="1333.121"/><line style="stroke:#a80036;stroke-width:1" x1="1432" x2="1473" y1="1333.121" y2="1333.121"/><polygon fill="#A80036" points="1442 1329.121 1432 1333.121 1442 1337.121 1438 1333.121" style="stroke:#a80036;stroke-width:1"/><text x="1438" y="1315.366" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234">stores `encrypted_request` in the queue.</text><polygon fill="#A80036" points="1419 1357.121 1429 1361.121 1419 1365.121 1423 1361.121" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1425" y1="1361.121" y2="1361.121"/><text x="862" y="1357.315" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390">`vcx_connection_update_state` all next steps are hidden in this call</text><polygon fill="#A80036" points="1419 1386.07 1429 1390.07 1419 1394.07 1423 1390.07" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1425" y1="1390.07" y2="1390.07"/><text x="862" y="1386.264" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217">get all messages {&apos;status&apos;: &apos;Received&apos;}</text><polygon fill="#A80036" points="866 1415.019 856 1419.019 866 1423.019 862 1419.019" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="860" x2="1430" y1="1419.019" y2="1419.019"/><text x="872" y="1415.212" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131">[ `encrypted_request` ]</text><line style="stroke:#a80036;stroke-width:1" x1="855" x2="897" y1="1656.698" y2="1656.698"/><line style="stroke:#a80036;stroke-width:1" x1="897" x2="897" y1="1656.698" y2="1669.698"/><line style="stroke:#a80036;stroke-width:1" x1="856" x2="897" y1="1669.698" y2="1669.698"/><polygon fill="#A80036" points="866 1665.698 856 1669.698 866 1673.698 862 1669.698" style="stroke:#a80036;stroke-width:1"/><text x="862" y="1651.943" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173">decrypt and process `request`</text><polygon fill="#FBFB77" points="8 1432.967 8 1875.967 846 1875.967 846 1442.967 836 1432.967 8 1432.967" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="1432.967" y2="1442.967"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="1442.967" y2="1442.967"/><text x="14" y="1450.161" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63">request = {</text><text x="22" y="1465.11" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146">&quot;@id&quot;: &quot;5678876542345&quot;,</text><text x="22" y="1480.059" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/didexchange/1.0/request&quot;,</text><text x="22" y="1495.007" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88">&quot;label&quot;: &quot;Alice&quot;,</text><text x="22" y="1509.956" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85">&quot;connection&quot;: {</text><text x="30" y="1524.905" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170">&quot;did&quot;: &quot;Bob Pairwise Verkey&quot;,</text><text x="46" y="1539.853" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67">&quot;did_doc&quot;: {</text><text x="38" y="1554.802" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">&quot;@context&quot;: &quot;https://w3id.org/did/v1&quot;</text><text x="38" y="1569.751" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144">&quot;id&quot;: &quot;did:sov:1234abcd&quot;,</text><text x="38" y="1584.7" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">&quot;publicKey&quot;: [</text><text x="46" y="1599.648" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="650">{&quot;id&quot;: &quot;Bob Pairwise Verkey&quot;, &quot;type&quot;: &quot;RsaVerificationKey2018&quot;, &quot;owner&quot;: &quot;did:sov:1234abcd&quot;,&quot;publicKeyPem&quot;: &quot;</text><text x="696" y="1599.648" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="line-through" textLength="4">-</text><text x="700" y="1599.648" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131">BEGIN PUBLIC X…&quot;},</text><text x="46" y="1614.597" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="635">{&quot;id&quot;: &quot;Bob Agent Verkey&quot;, &quot;type&quot;: &quot;RsaVerificationKey2018&quot;, &quot;owner&quot;: &quot;did:sov:1234abcd&quot;,&quot;publicKeyPem&quot;: &quot;</text><text x="681" y="1614.597" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="line-through" textLength="4">-</text><text x="685" y="1614.597" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127">BEGIN PUBLIC A…&quot;}</text><text x="38" y="1629.546" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8">],</text><text x="38" y="1644.495" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103">&quot;authentication&quot;: [</text><text x="46" y="1659.443" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="459">{&quot;type&quot;: &quot;RsaSignatureAuthentication2018&quot;, &quot;publicKey&quot;: &quot;did:sov:1234abcd#4&quot;}</text><text x="38" y="1674.392" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8">],</text><text x="38" y="1689.341" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64">&quot;service&quot;: [</text><text x="46" y="1704.29" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">{</text><text x="54" y="1719.238" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348">&quot;id&quot;: &quot;did:example:123456789abcdefghi;did-communication&quot;,</text><text x="54" y="1734.187" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166">&quot;type&quot;: &quot;did-communication&quot;,</text><text x="54" y="1749.136" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72">&quot;priority&quot; : 0,</text><text x="54" y="1764.084" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252">&quot;recipientKeys&quot; : [ &quot;Bob Pairwise Verkey&quot; ],</text><text x="54" y="1779.033" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227">&quot;routingKeys&quot; : [ &quot;Bob Agent Verkey&quot; ],</text><text x="54" y="1793.982" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425">&quot;serviceEndpoint&quot; : &quot;did:example:xd45fr567794lrzti67;did-communication&quot;</text><text x="46" y="1808.931" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><text x="38" y="1823.879" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">]</text><text x="30" y="1838.828" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><text x="22" y="1853.777" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><text x="14" y="1868.726" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><polygon fill="#A80036" points="1419 1901.48 1429 1905.48 1419 1909.48 1423 1905.48" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1425" y1="1905.48" y2="1905.48"/><text x="862" y="1901.674" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143">update messages status</text><rect style="stroke:#eee;stroke-width:1" width="2836" height="3" x="3" y="1934.904" fill="#EEE" filter="url(#f96s0w8)"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="1934.904" y2="1934.904"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="1937.904" y2="1937.904"/><rect style="stroke:#000;stroke-width:2" width="154" height="22.949" x="1344" y="1924.429" fill="#EEE" filter="url(#f96s0w8)"/><text x="1350" y="1940.623" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136">Connection Response</text><line style="stroke:#a80036;stroke-width:1" x1="855" x2="897" y1="1969.352" y2="1969.352"/><line style="stroke:#a80036;stroke-width:1" x1="897" x2="897" y1="1969.352" y2="1982.352"/><line style="stroke:#a80036;stroke-width:1" x1="856" x2="897" y1="1982.352" y2="1982.352"/><polygon fill="#A80036" points="866 1978.352 856 1982.352 866 1986.352 862 1982.352" style="stroke:#a80036;stroke-width:1"/><polygon fill="#FBFB77" points="550 1962.378 550 1986.378 846 1986.378 846 1972.378 836 1962.378 550 1962.378" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="1962.378" y2="1972.378"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="1972.378" y2="1972.378"/><text x="556" y="1979.572" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275">Alice generates `connection_response` for Bob.</text><polygon fill="#A80036" points="1667 2062.173 1677 2066.173 1667 2070.173 1671 2066.173" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1673" y1="2066.173" y2="2066.173"/><text x="862" y="2062.367" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497">Send `encrypted_fwd_response` to `serviceEndpoint` taken from `connection_request`</text><polygon fill="#FBFB77" points="387 2001.327 387 2115.327 846 2115.327 846 2011.327 836 2001.327 387 2001.327" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="2001.327" y2="2011.327"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="2011.327" y2="2011.327"/><text x="393" y="2018.521" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438">encrypted_fwd_response = &lt;pack(forward_message, &quot;Bob Agent Verkey&quot;)&gt;</text><text x="393" y="2048.418" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122">forward_message = {</text><text x="401" y="2063.367" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/routing/1.0/forward&quot;,</text><text x="401" y="2078.315" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176">&quot;to&quot; : &quot;Bob Pairwise Verkey&quot;,</text><text x="401" y="2093.264" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242">&quot;msg&quot; : encrypted_connection_response</text><text x="393" y="2108.213" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><line style="stroke:#a80036;stroke-width:1" x1="1679" x2="1721" y1="2383.596" y2="2383.596"/><line style="stroke:#a80036;stroke-width:1" x1="1721" x2="1721" y1="2383.596" y2="2396.596"/><line style="stroke:#a80036;stroke-width:1" x1="1680" x2="1721" y1="2396.596" y2="2396.596"/><polygon fill="#A80036" points="1690 2392.596 1680 2396.596 1690 2400.596 1686 2396.596" style="stroke:#a80036;stroke-width:1"/><text x="1686" y="2378.841" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249">decrypts `encrypted_connection_response`</text><polygon fill="#FBFB77" points="1947 2129.968 1947 2632.968 2825 2632.968 2825 2139.968 2815 2129.968 1947 2129.968" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="2815" x2="2815" y1="2129.968" y2="2139.968"/><line style="stroke:#a80036;stroke-width:1" x1="2825" x2="2815" y1="2139.968" y2="2139.968"/><text x="1953" y="2147.162" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="662">encrypted_connection_response = &lt;pack(connection_response, &quot;Bob Pairwise Verkey&quot;, &quot;Alice Pairwise Verkey&quot;)&gt;</text><text x="1953" y="2177.059" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143">connection_response = {</text><text x="1961" y="2192.008" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146">&quot;@id&quot;: &quot;5678876542345&quot;,</text><text x="1961" y="2206.956" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="473">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/didexchange/1.0/response&quot;,</text><text x="1961" y="2221.905" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88">&quot;label&quot;: &quot;Alice&quot;,</text><text x="1961" y="2236.854" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85">&quot;connection&quot;: {</text><text x="1969" y="2251.803" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176">&quot;did&quot;: &quot;Alice Pairwise Verkey&quot;,</text><text x="1985" y="2266.751" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67">&quot;did_doc&quot;: {</text><text x="1977" y="2281.7" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">&quot;@context&quot;: &quot;https://w3id.org/did/v1&quot;</text><text x="1977" y="2296.649" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">&quot;@context&quot;: &quot;https://w3id.org/did/v1&quot;</text><text x="1977" y="2311.598" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144">&quot;id&quot;: &quot;did:sov:1234abcd&quot;,</text><text x="1977" y="2326.546" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">&quot;publicKey&quot;: [</text><text x="1985" y="2341.495" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="656">{&quot;id&quot;: &quot;Alice Pairwise Verkey&quot;, &quot;type&quot;: &quot;RsaVerificationKey2018&quot;, &quot;owner&quot;: &quot;did:sov:1234abcd&quot;,&quot;publicKeyPem&quot;: &quot;</text><text x="2641" y="2341.495" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="line-through" textLength="4">-</text><text x="2645" y="2341.495" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131">BEGIN PUBLIC X…&quot;},</text><text x="1985" y="2356.444" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="651">{&quot;id&quot;: &quot;Alice Agency Verkey&quot;, &quot;type&quot;: &quot;RsaVerificationKey2018&quot;, &quot;owner&quot;: &quot;did:sov:1234abcd&quot;,&quot;publicKeyPem&quot;: &quot;</text><text x="2636" y="2356.444" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="line-through" textLength="4">-</text><text x="2640" y="2356.444" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129">BEGIN PUBLIC 9…&quot;},</text><text x="1985" y="2371.393" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="694">{&quot;id&quot;: &quot;Alice Agent Pairwise Verkey&quot;, &quot;type&quot;: &quot;RsaVerificationKey2018&quot;, &quot;owner&quot;: &quot;did:sov:1234abcd&quot;,&quot;publicKeyPem&quot;: &quot;</text><text x="2679" y="2371.393" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="line-through" textLength="4">-</text><text x="2683" y="2371.393" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127">BEGIN PUBLIC A…&quot;}</text><text x="1977" y="2386.341" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8">],</text><text x="1977" y="2401.29" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103">&quot;authentication&quot;: [</text><text x="1985" y="2416.239" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="459">{&quot;type&quot;: &quot;RsaSignatureAuthentication2018&quot;, &quot;publicKey&quot;: &quot;did:sov:1234abcd#4&quot;}</text><text x="1977" y="2431.188" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8">],</text><text x="1977" y="2446.136" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64">&quot;service&quot;: [</text><text x="1985" y="2461.085" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">{</text><text x="1993" y="2476.034" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348">&quot;id&quot;: &quot;did:example:123456789abcdefghi;did-communication&quot;,</text><text x="1993" y="2490.982" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166">&quot;type&quot;: &quot;did-communication&quot;,</text><text x="1993" y="2505.931" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72">&quot;priority&quot; : 0,</text><text x="1993" y="2520.88" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258">&quot;recipientKeys&quot; : [ &quot;Alice Pairwise Verkey&quot; ],</text><text x="1993" y="2535.829" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426">&quot;routingKeys&quot; : [ &quot;Alice Agency Verkey&quot;, &quot;Alice Pairwise Agent Verkey&quot; ],</text><text x="1993" y="2550.777" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297">&quot;serviceEndpoint&quot; : &quot;https://example.com/endpoint&quot;</text><text x="1985" y="2565.726" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><text x="1977" y="2580.675" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">]</text><text x="1969" y="2595.624" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><text x="1961" y="2610.572" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><text x="1953" y="2625.521" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><rect style="stroke:#eee;stroke-width:1" width="2836" height="3" x="3" y="2662.75" fill="#EEE" filter="url(#f96s0w8)"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="2662.75" y2="2662.75"/><line style="stroke:#000;stroke-width:1" x1="3" x2="2839" y1="2665.75" y2="2665.75"/><rect style="stroke:#000;stroke-width:2" width="41" height="22.949" x="1400.5" y="2652.276" fill="#EEE" filter="url(#f96s0w8)"/><text x="1406.5" y="2668.47" fill="#000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="23">Ack</text><polygon fill="#A80036" points="1070 2751.071 1060 2755.071 1070 2759.071 1066 2755.071" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1064" x2="1678" y1="2755.071" y2="2755.071"/><text x="1076" y="2751.265" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236">sens `encrypted_fwd_response` for Alice</text><polygon fill="#FBFB77" points="1684 2690.225 1684 2804.225 2159 2804.225 2159 2700.225 2149 2690.225 1684 2690.225" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="2149" x2="2149" y1="2690.225" y2="2700.225"/><line style="stroke:#a80036;stroke-width:1" x1="2159" x2="2149" y1="2700.225" y2="2700.225"/><text x="1690" y="2707.419" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454">encrypted_fwd_response = &lt;pack(forward_message, &quot;Alice Agency Verkey&quot;)&gt;</text><text x="1690" y="2737.316" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122">forward_message = {</text><text x="1698" y="2752.265" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/routing/1.0/forward&quot;,</text><text x="1698" y="2767.213" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220">&quot;to&quot; : &quot;Alice Pairwise Agent Verkey&quot;,</text><text x="1698" y="2782.162" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256">&quot;msg&quot; : encrypted_forward_inner_message</text><text x="1690" y="2797.111" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><polygon fill="#A80036" points="1419 2829.866 1429 2833.866 1419 2837.866 1423 2833.866" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="1059" x2="1425" y1="2833.866" y2="2833.866"/><text x="1066" y="2830.06" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255">forward `encrypted_forward_inner_message`</text><line style="stroke:#a80036;stroke-width:1" x1="1431" x2="1473" y1="2899.635" y2="2899.635"/><line style="stroke:#a80036;stroke-width:1" x1="1473" x2="1473" y1="2899.635" y2="2912.635"/><line style="stroke:#a80036;stroke-width:1" x1="1432" x2="1473" y1="2912.635" y2="2912.635"/><polygon fill="#A80036" points="1442 2908.635 1432 2912.635 1442 2916.635 1438 2912.635" style="stroke:#a80036;stroke-width:1"/><polygon fill="#FBFB77" points="1481 2847.814 1481 2961.814 2091 2961.814 2091 2857.814 2081 2847.814 1481 2847.814" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="2081" x2="2081" y1="2847.814" y2="2857.814"/><line style="stroke:#a80036;stroke-width:1" x1="2091" x2="2081" y1="2857.814" y2="2857.814"/><text x="1487" y="2865.008" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="589">encrypted_forward_inner_message = &lt;pack(forward_inner_message, &quot;Alice Pairwise Agent Verkey&quot;)&gt;</text><text x="1487" y="2894.906" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157">forward_inner_message = {</text><text x="1495" y="2909.854" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/routing/1.0/forward&quot;,</text><text x="1495" y="2924.803" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182">&quot;to&quot; : &quot;Alice Pairwise Verkey&quot;,</text><text x="1495" y="2939.752" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140">&quot;msg&quot; : encrypted_ack</text><text x="1487" y="2954.701" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text><line style="stroke:#a80036;stroke-width:1" x1="1431" x2="1473" y1="2992.404" y2="2992.404"/><line style="stroke:#a80036;stroke-width:1" x1="1473" x2="1473" y1="2992.404" y2="3005.404"/><line style="stroke:#a80036;stroke-width:1" x1="1432" x2="1473" y1="3005.404" y2="3005.404"/><polygon fill="#A80036" points="1442 3001.404 1432 3005.404 1442 3009.404 1438 3005.404" style="stroke:#a80036;stroke-width:1"/><text x="1438" y="2987.649" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">stores `encrypted_ack` in the queue.</text><polygon fill="#A80036" points="1419 3029.404 1429 3033.404 1419 3037.404 1423 3033.404" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1425" y1="3033.404" y2="3033.404"/><text x="862" y="3029.598" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390">`vcx_connection_update_state` all next steps are hidden in this call</text><polygon fill="#A80036" points="1419 3058.353 1429 3062.353 1419 3066.353 1423 3062.353" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="855" x2="1425" y1="3062.353" y2="3062.353"/><text x="862" y="3058.547" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217">get all messages {&apos;status&apos;: &apos;Received&apos;}</text><polygon fill="#A80036" points="866 3087.302 856 3091.302 866 3095.302 862 3091.302" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="860" x2="1430" y1="3091.302" y2="3091.302"/><text x="872" y="3087.496" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109">[ `encrypted_ack` ]</text><line style="stroke:#a80036;stroke-width:1" x1="855" x2="897" y1="3186.968" y2="3186.968"/><line style="stroke:#a80036;stroke-width:1" x1="897" x2="897" y1="3186.968" y2="3199.968"/><line style="stroke:#a80036;stroke-width:1" x1="856" x2="897" y1="3199.968" y2="3199.968"/><polygon fill="#A80036" points="866 3195.968 856 3199.968 866 3203.968 862 3199.968" style="stroke:#a80036;stroke-width:1"/><text x="862" y="3182.214" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151">decrypt and process `ack`</text><polygon fill="#FBFB77" points="304 3105.251 304 3264.251 846 3264.251 846 3115.251 836 3105.251 304 3105.251" filter="url(#f96s0w8)" style="stroke:#a80036;stroke-width:1"/><line style="stroke:#a80036;stroke-width:1" x1="836" x2="836" y1="3105.251" y2="3115.251"/><line style="stroke:#a80036;stroke-width:1" x1="846" x2="836" y1="3115.251" y2="3115.251"/><text x="310" y="3122.444" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458">encrypted_ack = &lt;pack(ack, &quot;Alice Pairwise Verkey&quot;, &quot;Bob Pairwise Verkey&quot;)&gt;</text><text x="310" y="3152.342" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41">ack = {</text><text x="326" y="3167.291" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431">&quot;@type&quot;: &quot;did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/notification/1.0/ack&quot;,</text><text x="326" y="3182.239" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146">&quot;@id&quot;: &quot;5678876542345&quot;,</text><text x="326" y="3197.188" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">&quot;status&quot;: &quot;OK&quot;,</text><text x="326" y="3212.137" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66">&quot;~thread&quot;: {</text><text x="342" y="3227.085" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="489">&quot;thid&quot;: &quot;&lt;The Thread ID is the Message ID (@id) of the first message in the thread&gt;&quot;</text><text x="326" y="3242.034" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8">},</text><text x="310" y="3256.983" fill="#000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4">}</text></g></svg>